-- Truy vấn chuyến bay 
--20127395_ Phan Minh Xuân
USE MASTER 
GO
IF DB_ID('QLCB1') IS NOT NULL
	DROP  DATABASE QLCB1
CREATE DATABASE QLCB1
GO
USE QLCB1
GO
--TAO BẢNG KHOA

CREATE TABLE KHACHHANG 
(
	MAKH CHAR (15) NOT NULL,
	TEN CHAR (15),
	DCHI VARCHAR (50),
	DTHOAI CHAR(12) 

	CONSTRAINT PK_KHACHHANG
	PRIMARY KEY (MAKH)
)

CREATE TABLE NHANVIEN 
(
	MANV CHAR (15),
	TEN CHAR (15),
	DCHI VARCHAR (50),
	DTHOAI CHAR(12)UNIQUE ,
	LUONG FLOAT,
	LOAINV BIT

	CONSTRAINT PK_NHANVIEN
	PRIMARY KEY (MANV)
)

CREATE TABLE LOAIMB
(
	HANGSX CHAR (15),
	MALOAI CHAR(15)

	CONSTRAINT PK_LOAIMB
	PRIMARY KEY (MALOAI)
)

CREATE TABLE MAYBAY 
(
	SOHIEU INT,
	MALOAI CHAR(15)

	CONSTRAINT PK_MAYBAY
	PRIMARY KEY (SOHIEU,MALOAI)
)

CREATE TABLE CHUYENBAY
(
	MACB CHAR (4),
	SBDI CHAR (3),
	SBDEN CHAR(3),
	GIODI TIME,
	GIODEN TIME

	CONSTRAINT PK_CHUYENBAY
	PRIMARY KEY (MACB)
)

CREATE TABLE LICHBAY
(
	NGAYDI DATE,
	MACB CHAR (4),
	SOHIEU INT,
	MALOAI CHAR (15)

	CONSTRAINT PK_LICHBAY
	PRIMARY KEY (NGAYDI,MACB)
)

CREATE TABLE DATCHO
(
	MAKH CHAR (15),
	NGAYDI DATE,
	MACB CHAR (4)

	CONSTRAINT PK_DATCHO
	PRIMARY KEY (MAKH,NGAYDI,MACB)
)

CREATE TABLE KHANANG
(
	MANV CHAR(15),
	MALOAI CHAR(15)

	CONSTRAINT PK_KHANANG
	PRIMARY KEY (MANV, MALOAI)
)

CREATE TABLE PHANCONG
(
	MANV CHAR (15),
	NGAYDI DATE,
	MACB CHAR (4)

	CONSTRAINT PK_PHANCONG
	PRIMARY KEY (MANV,NGAYDI,MACB)
)

--KHOA NGOAI

ALTER TABLE DATCHO 
ADD 
	CONSTRAINT FK_DATCHO_KHACHHANG
	FOREIGN KEY(MAKH) 
	REFERENCES KHACHHANG,

	CONSTRAINT FK_DATCHO_LICHBAY
	FOREIGN KEY(NGAYDI,MACB) 
	REFERENCES LICHBAY


ALTER TABLE LICHBAY
ADD 
	CONSTRAINT FK_LICHBAY_CHUYENBAY
	FOREIGN KEY(MACB) 
	REFERENCES CHUYENBAY,

	CONSTRAINT FK_LICHBAY_MAYBAY
	FOREIGN KEY(SOHIEU,MALOAI) 
	REFERENCES MAYBAY


ALTER TABLE MAYBAY
ADD 
	CONSTRAINT FK_MAYBAY_LOAIMB
	FOREIGN KEY(MALOAI) 
	REFERENCES LOAIMB

ALTER TABLE KHANANG
ADD 
	CONSTRAINT FK_KHANANG_LOAIMB
	FOREIGN KEY(MALOAI) 
	REFERENCES LOAIMB,

	CONSTRAINT FK_KHANANG_NHANVIEN
	FOREIGN KEY(MANV) 
	REFERENCES NHANVIEN

ALTER TABLE PHANCONG
ADD 
	CONSTRAINT FK_PC_NV
	FOREIGN KEY(MANV) 
	REFERENCES NHANVIEN,
	
	CONSTRAINT FK_PC_LB
	FOREIGN KEY(NGAYDI,MACB) 
	REFERENCES LICHBAY

	--NHAP DL
INSERT INTO KHACHHANG VALUES ('0009' ,'Nga',' 223 Nguyen Trai ','8932320')
INSERT INTO KHACHHANG VALUES ('0101' ,'Anh',' 567 Tran Phu ','8826729')
INSERT INTO KHACHHANG VALUES ('0045' ,'Thu','285 Le Loi ','8932203')
INSERT INTO KHACHHANG VALUES ('0012' ,'Ha','435 Quang Trung ','8933232')
INSERT INTO KHACHHANG VALUES ('0238' ,'Hung',' 456 Pasteur ','9812101')
INSERT INTO KHACHHANG VALUES ('0397' ,'Thanh',' 234 Le Van Si ','8952943')
INSERT INTO KHACHHANG VALUES ('0582' ,'Mai',' 789 Nguyen Du ',NULL)
INSERT INTO KHACHHANG VALUES ('0934' ,'Minh',' 678 Le Lai ',NULL )
INSERT INTO KHACHHANG VALUES ('0091' ,'Hai',' 345 Hung Vuong ','8893223')
INSERT INTO KHACHHANG VALUES ('0314' ,'Phuong',' 395 Vo Van Tan ','8232320')
INSERT INTO KHACHHANG VALUES ('0613' ,'Vu',' 348 CMT8 ','8343232')
INSERT INTO KHACHHANG VALUES ('0586' ,'Son',' 123 Bach Dang ','8556223')
INSERT INTO KHACHHANG VALUES ('0422' ,'Tien','75 Nguyen Thong','8332222')

INSERT INTO LOAIMB VALUES ('Airbus', 'A310')
INSERT INTO LOAIMB VALUES ('Airbus', 'A320')
INSERT INTO LOAIMB VALUES ('Airbus', 'A330')
INSERT INTO LOAIMB VALUES ('Airbus', 'A340')
INSERT INTO LOAIMB VALUES ('Boeing', 'B727')
INSERT INTO LOAIMB VALUES ('Boeing', 'B747')
INSERT INTO LOAIMB VALUES ('Boeing', 'B757')
INSERT INTO LOAIMB VALUES ('MD', 'DC10')
INSERT INTO LOAIMB VALUES ('MD', 'DC9')

INSERT INTO NHANVIEN VALUES('1006', 'Chi', '12/6 Nguyen Kiem', '8120012', 150000 ,0)
INSERT INTO NHANVIEN VALUES('1005', 'Giao', '65 Nguyen Thai Son', '8324467', 500000 ,0)
INSERT INTO NHANVIEN VALUES('1001', 'Huong', '8 Dien Bien Phu', '8330733', 500000 ,1)
INSERT INTO NHANVIEN VALUES('1002', 'Phong', '1 Ly Thuong Kiet', '8308117', 450000 ,1)
INSERT INTO NHANVIEN VALUES('1004', 'Phuong', '351 Lac Long Quan', '8308155', 250000 ,0)
INSERT INTO NHANVIEN VALUES('1003', 'Quang', '78 Truong Dinh', '8324461', 350000 ,1)
INSERT INTO NHANVIEN VALUES('1007', 'Tam', '36 Nguyen Van Cu', '8458188', 500000 ,0)

INSERT INTO KHANANG VALUES('1001', 'B727')
INSERT INTO KHANANG VALUES('1001', 'B747')
INSERT INTO KHANANG VALUES('1001', 'DC10')
INSERT INTO KHANANG VALUES('1001', 'DC9')
INSERT INTO KHANANG VALUES('1002', 'A320')
INSERT INTO KHANANG VALUES('1002', 'A340')
INSERT INTO KHANANG VALUES('1002', 'B757')
INSERT INTO KHANANG VALUES('1002', 'DC9')
INSERT INTO KHANANG VALUES('1003', 'A310')
INSERT INTO KHANANG VALUES('1003', 'DC9')

INSERT INTO MAYBAY VALUES (10, 'B747')
INSERT INTO MAYBAY VALUES (11, 'B727')
INSERT INTO MAYBAY VALUES (13, 'B727')
INSERT INTO MAYBAY VALUES (13, 'B747')
INSERT INTO MAYBAY VALUES (21, 'DC10')
INSERT INTO MAYBAY VALUES (21, 'DC9')
INSERT INTO MAYBAY VALUES (22, 'B757')
INSERT INTO MAYBAY VALUES (22, 'DC9')
INSERT INTO MAYBAY VALUES (23, 'DC9')
INSERT INTO MAYBAY VALUES (24, 'DC9')
INSERT INTO MAYBAY VALUES (70, 'A310')
INSERT INTO MAYBAY VALUES (80, 'A310')
INSERT INTO MAYBAY VALUES (93, 'B757')

INSERT INTO CHUYENBAY VALUES('100','SLC','BOS',' 08:00',' 17:50')
INSERT INTO CHUYENBAY VALUES('112','DCA','DEN',' 14:00',' 18:07')
INSERT INTO CHUYENBAY VALUES('121','STL','SLC',' 04:00',' 09:13')
INSERT INTO CHUYENBAY VALUES('122','STL','YYV',' 08:30',' 10:19')
INSERT INTO CHUYENBAY VALUES('206','DFW','STL',' 09:00',' 11:40')
INSERT INTO CHUYENBAY VALUES('330','JFK','YYV',' 16:00',' 18:53')
INSERT INTO CHUYENBAY VALUES('334','ORD','MIA',' 12:00',' 14:14')
INSERT INTO CHUYENBAY VALUES('335','MIA','ORD',' 15:00',' 17:14')
INSERT INTO CHUYENBAY VALUES('336','ORD','MIA',' 18:00',' 20:14')
INSERT INTO CHUYENBAY VALUES('337','MIA','ORD',' 20:30',' 23:53')
INSERT INTO CHUYENBAY VALUES('394','DFW','MIA',' 19:00',' 21:20')
INSERT INTO CHUYENBAY VALUES('395','MIA','DFW',' 21:00',' 23:43')
INSERT INTO CHUYENBAY VALUES('449','CDG','DEN',' 10:00',' 19:29')
INSERT INTO CHUYENBAY VALUES('930','YYV','DCA',' 13:00',' 16:10')
INSERT INTO CHUYENBAY VALUES('931','DCA','YYV',' 17:00',' 18:10')
INSERT INTO CHUYENBAY VALUES('932','DCA','YYV',' 18:00',' 19:10')
INSERT INTO CHUYENBAY VALUES('991','BOS','ORD',' 17:00',' 12:22')

INSERT INTO LICHBAY VALUES('11/01/2000', '100', 80, 'A310')
INSERT INTO LICHBAY VALUES('11/01/2000', '112', 21, 'DC10')
INSERT INTO LICHBAY VALUES('11/01/2000', '206', 22, 'DC9')
INSERT INTO LICHBAY VALUES('11/01/2000', '334', 10, 'B747')
INSERT INTO LICHBAY VALUES('11/01/2000', '395', 23, 'DC9')
INSERT INTO LICHBAY VALUES('11/01/2000', '991', 22, 'B757')
INSERT INTO LICHBAY VALUES('11/01/2000', '337', 10, 'B747')
INSERT INTO LICHBAY VALUES('10/31/2000', '100', 11, 'B727')
INSERT INTO LICHBAY VALUES('10/31/2000', '112', 11, 'B727')
INSERT INTO LICHBAY VALUES('10/31/2000', '206', 13, 'B727')
INSERT INTO LICHBAY VALUES('10/31/2000', '334', 10, 'B747')
INSERT INTO LICHBAY VALUES('10/31/2000', '335', 10, 'B747')
INSERT INTO LICHBAY VALUES('10/31/2000', '337', 24, 'DC9')
INSERT INTO LICHBAY VALUES('10/31/2000', '449', 70, 'A310')

INSERT INTO DATCHO VALUES ('0009',' 11/01/2000' ,'100')
INSERT INTO DATCHO VALUES ('0009',' 10/31/2000' ,'449')
INSERT INTO DATCHO VALUES ('0045',' 11/01/2000' ,'991')
INSERT INTO DATCHO VALUES ('0012',' 10/31/2000' ,'206')
INSERT INTO DATCHO VALUES ('0238',' 10/31/2000' ,'334')
INSERT INTO DATCHO VALUES ('0582',' 11/01/2000' ,'991')
INSERT INTO DATCHO VALUES ('0091',' 11/01/2000' ,'100')
INSERT INTO DATCHO VALUES ('0314',' 10/31/2000' ,'449')
INSERT INTO DATCHO VALUES ('0613',' 11/01/2000' ,'100')
INSERT INTO DATCHO VALUES ('0586',' 11/01/2000' ,'991')
INSERT INTO DATCHO VALUES ('0586',' 10/31/2000' ,'100')
INSERT INTO DATCHO VALUES ('0422',' 10/31/2000' ,'449')

INSERT INTO PHANCONG VALUES('1001', '11/01/2000', '100')
INSERT INTO PHANCONG VALUES('1001', '10/31/2000', '100')
INSERT INTO PHANCONG VALUES('1002', '11/01/2000', '100')
INSERT INTO PHANCONG VALUES('1002', '10/31/2000', '100')
INSERT INTO PHANCONG VALUES('1003', '10/31/2000', '100')
INSERT INTO PHANCONG VALUES('1003', '10/31/2000', '337')
INSERT INTO PHANCONG VALUES('1004', '10/31/2000', '100')
INSERT INTO PHANCONG VALUES('1004', '10/31/2000', '337')
INSERT INTO PHANCONG VALUES('1005', '10/31/2000', '337')
INSERT INTO PHANCONG VALUES('1006', '11/01/2000', '991')
INSERT INTO PHANCONG VALUES('1006', '10/31/2000', '337')
INSERT INTO PHANCONG VALUES('1007', '11/01/2000', '112')
INSERT INTO PHANCONG VALUES('1007', '11/01/2000', '991')
INSERT INTO PHANCONG VALUES('1007', '10/31/2000', '206')

SELECT *FROM CHUYENBAY
SELECT *FROM DATCHO
SELECT *FROM LOAIMB
SELECT *FROM NHANVIEN
SELECT *FROM KHANANG
SELECT *FROM KHACHHANG
SELECT *FROM LICHBAY
SELECT *FROM MAYBAY
SELECT *FROM PHANCONG

--34. Cho biết hãng sản xuất, mã loại và số hiệu của máy bay đã được sử dụng nhiều nhất.
SELECT DISTINCT L.HANGSX ,L.MALOAI,LB.SOHIEU
FROM LOAIMB L ,LICHBAY LB
WHERE L.MALOAI=LB.MALOAI
GROUP BY L.HANGSX ,L.MALOAI,LB.SOHIEU
HAVING COUNT (L.MALOAI) >= ALL (SELECT COUNT(LB.MALOAI)
								FROM LICHBAY LB
								GROUP BY LB.MALOAI)
--35. Cho biết tên nhân viên được phân công đi nhiều chuyến bay nhất.
SELECT NV.TEN
FROM NHANVIEN NV ,PHANCONG PC
WHERE NV.MANV=PC.MANV
GROUP BY NV.TEN
HAVING COUNT (NV.MANV ) >= ALL ( SELECT COUNT ( PB.MANV)
							 FROM PHANCONG PB
							 GROUP BY PB.MANV)   
--36. Cho biết thông tin của phi công (tên, địa chỉ, điện thoại) lái nhiều chuyến bay nhất.
 SELECT NV.TEN, NV.DCHI, NV.DTHOAI
 FROM NHANVIEN NV, PHANCONG PC
 WHERE PC.MANV = NV.MANV AND NV.LOAINV = 1
 GROUP BY NV.TEN, NV.DCHI, NV.DTHOAI
 HAVING COUNT(*) >= ALL (SELECT COUNT(*)
						 FROM PHANCONG PC, NHANVIEN NV
						 WHERE PC.MANV = NV.MANV AND NV.LOAINV = 1
						 GROUP BY PC.MANV)
--37. Cho biết sân bay (SBDEN) và số lượng chuyến bay của sân bay có ít chuyến bay đáp xuống nhất.
SELECT CB.SBDEN,COUNT (SBDEN)'số lượng chuyến bay'
FROM CHUYENBAY CB
GROUP BY CB.SBDEN
HAVING COUNT (CB.SBDEN ) <= ALL ( SELECT COUNT ( PC.SBDEN)
							 FROM CHUYENBAY PC
							 GROUP BY PC.SBDEN)
--38. Cho biết sân bay (SBDI) và số lượng chuyến bay của sân bay có nhiều chuyến bay xuất phát nhất.
SELECT CB.SBDI,COUNT (SBDI)'số lượng chuyến bay'
FROM CHUYENBAY CB
GROUP BY CB.SBDI
HAVING COUNT (CB.SBDI ) >= ALL ( SELECT COUNT ( PC.SBDI)
							 FROM CHUYENBAY PC
							 GROUP BY PC.SBDI)
--39. Cho biết tên, địa chỉ, và điện thoại của khách hàng đã đi trên nhiều chuyến bay nhất.
SELECT KH.TEN,KH.DCHI,KH.DTHOAI
FROM KHACHHANG KH ,DATCHO DC
WHERE KH.MAKH=DC.MAKH
GROUP BY KH.TEN,KH.DCHI,KH.DTHOAI
HAVING COUNT (KH.MAKH ) >= ALL ( SELECT COUNT ( DC.MAKH)
							 FROM DATCHO DC
							 GROUP BY DC.MAKH)
--40. Cho biết mã số, tên và lương của các phi công có khả năng lái nhiều loại máy bay nhất.
SELECT NV.MANV, NV.TEN,NV.LUONG
FROM NHANVIEN NV ,KHANANG KN
WHERE NV.MANV=KN.MANV 
GROUP BY NV.MANV, NV.TEN,NV.LUONG
HAVING COUNT (NV.MANV ) >= ALL ( SELECT COUNT ( KN.MANV)
							 FROM KHANANG KN
							 GROUP BY KN.MANV)
--41. Cho biết thông tin (mã nhân viên, tên, lương) của nhân viên có mức lương cao nhất.
SELECT NV.MANV, NV.TEN,NV.LUONG
FROM NHANVIEN NV
WHERE NV.LOAINV=0 AND LUONG >= ALL (SELECT LUONG FROM NHANVIEN )
--42. Cho biết tên, địa chỉ của các nhân viên có lương cao nhất trong phi hành đoàn (các nhân viên được phân công trong một chuyến bay) mà người đó tham gia.
SELECT DISTINCT   NV.TEN,NV.DCHI,NV.LUONG
FROM NHANVIEN NV,PHANCONG PC
WHERE PC.MANV=NV.MANV AND NV.LOAINV=0 AND LUONG >= ALL (SELECT LUONG FROM NHANVIEN )
--43. Cho biết mã chuyến bay, giờ đi và giờ đến của chuyến bay bay sớm nhất trong ngày.
SELECT CB.MACB, LB.NGAYDI, CB.GIODI, CB.GIODEN
FROM LICHBAY LB, CHUYENBAY CB
WHERE LB.MACB = CB.MACB AND EXISTS (
          SELECT*
          FROM LICHBAY LB1, CHUYENBAY CB1
          WHERE LB1.MACB = CB1.MACB AND LB.NGAYDI = LB1.NGAYDI
          GROUP BY LB1.NGAYDI
          HAVING CB.GIODI = MIN(CB1.GIODI)
          )
--44. Cho biết mã chuyến bay có thời gian bay dài nhất. Xuất ra mã chuyến bay và thời gian bay (tính bằng phút).
SELECT CB.MACB, DATEDIFF(MI, CB.GIODI, CB.GIODEN)'thời gian bay (tính bằng phút)'
FROM CHUYENBAY CB
WHERE DATEDIFF(MI, CB.GIODI, CB.GIODEN) >= ALL (SELECT DATEDIFF(MI, CB.GIODI, CB.GIODEN) 
												FROM CHUYENBAY CB)
--45. Cho biết mã chuyến bay có thời gian bay ít nhất. Xuất ra mã chuyến bay và thời gian bay.
 SELECT CB.MACB, DATEDIFF(MI, CB.GIODI, CB.GIODEN)
 FROM CHUYENBAY CB
 WHERE DATEDIFF(MI, CB.GIODI, CB.GIODEN) <= ALL (SELECT DATEDIFF(MI, CB.GIODI, CB.GIODEN) 
												 FROM CHUYENBAY CB)
--46. Cho biết mã chuyến bay và ngày đi của những chuyến bay bay trên loại máy bay B747 nhiều nhất.
SELECT MACB, NGAYDI
FROM LICHBAY LB
WHERE EXISTS(
   SELECT *
   FROM LICHBAY LB1
   WHERE LB1.MALOAI = 'B747' AND LB1.MACB = LB.MACB
   GROUP BY MACB
   HAVING COUNT(LB1.NGAYDI) >= ALL (SELECT COUNT(LB2.NGAYDI)
									FROM LICHBAY LB2
								    WHERE LB2.MALOAI = 'B747'
									GROUP BY MACB))
--47. Với mỗi chuyến bay có trên 3 hành khách, cho biết mã chuyến bay và số lượng nhân viên trên chuyến bay đó. Xuất ra mã chuyến bay và số lượng nhân viên.
 SELECT LB.MACB, COUNT(DISTINCT PC.MANV) 'số lượng nhân viên'
 FROM DATCHO DC, PHANCONG PC, LICHBAY LB
 WHERE DC.MACB = LB.MACB AND DC.NGAYDI = LB.NGAYDI AND PC.NGAYDI = LB.NGAYDI AND PC.MACB = LB.MACB
 GROUP BY LB.MACB, LB.NGAYDI
 HAVING COUNT(DISTINCT DC.MAKH) > 2
--48. Với mỗi loại nhân viên có tổng lương trên 600000, cho biết số lượng nhân viên trong từng loại nhân viên đó. Xuất ra loại nhân viên, và số lượng nhân viên tương ứng.
SELECT NV.LOAINV,COUNT (NV.MANV)'số lượng nhân viên'
FROM NHANVIEN NV 
GROUP BY  NV.LOAINV
HAVING SUM (LUONG)>600000
--49. Với mỗi chuyến bay có trên 3 nhân viên, cho biết mã chuyến bay và số lượng khách hàng đã đặt chỗ trên chuyến bay đó.
SELECT LB.MACB, COUNT(DISTINCT DC.MAKH) 'số lượng khách'
FROM DATCHO DC, PHANCONG PC, LICHBAY LB
WHERE DC.MACB = LB.MACB AND DC.NGAYDI = LB.NGAYDI AND PC.NGAYDI = LB.NGAYDI AND PC.MACB = LB.MACB
GROUP BY LB.MACB, LB.NGAYDI
HAVING COUNT(DISTINCT PC.MANV) > 2		
--50. Với mỗi loại máy bay có nhiều hơn một chiếc, cho biết số lượng chuyến bay đã được bố trí bay bằng loại máy bay đó. Xuất ra mã loại và số lượng.
 SELECT LB.MALOAI, COUNT(*) 'số lượng chuyến bay'
 FROM LICHBAY LB
 WHERE LB.MALOAI IN (SELECT MALOAI
      FROM MAYBAY MB
      GROUP BY MALOAI
      HAVING COUNT(*) > 1)
 GROUP BY LB.MALOAI